# Nekro Bilibili Plugin

一个用于监控哔哩哔哩直播状态的 Nekro Agent 插件，支持自动检测主播开播/下播状态并通过 QQ 群发送通知。

## 功能特性

- 🎥 **实时监控**: 定期检查指定 B 站直播间的开播状态
- 📢 **智能通知**: 检测到开播/下播时自动发送通知到指定 QQ 群
- 💾 **状态持久化**: 本地保存直播状态，避免重复通知
- 🔧 **灵活配置**: 支持自定义监控间隔、通知群、房间号等参数
- 🛡️ **错误处理**: 完善的异常处理和重试机制
- 📊 **详细日志**: 提供详细的运行日志和调试信息

## 安装方法

1. 将插件文件放置在 Nekro Agent 的 `plugins/workdir/` 目录下
2. 确保 `nekro_plugin_bilibili` 文件夹结构完整
3. 重启 Nekro Agent 或重新加载插件

## 配置说明

在 Nekro Agent 的 Web 界面中配置以下参数：

### 基础配置

| 配置项 | 类型 | 默认值 | 说明 |
|--------|------|--------|------|
| `check_interval` | 整数 | 10 | 轮询间隔（秒），建议不要设置太短避免被限制 |
| `notification_group` | 字符串 | "" | 需要发送通知的 QQ 群号 |
| `room_id` | 整数 | 0 | 监控的 B 站直播间房间号 |
| `streamer_name` | 字符串 | "主播" | 主播的名字或昵称，用于通知消息中显示 |

## 文件结构

```
nekro_plugin_bilibili/
├── __init__.py          # 插件入口和生命周期管理
├── conf.py              # 插件配置定义
├── models.py            # 数据模型定义
├── api_client.py        # B 站 API 客户端
├── poll_manager.py      # 轮询管理器
└── handlers.py          # 通知处理器
```

## 工作原理

1. **初始化**: 插件加载时启动轮询管理器并注册回调函数
2. **状态轮询**: 按照配置的间隔时间检查直播间状态
3. **状态比较**: 将当前状态与本地保存的状态进行比较
4. **通知发送**: 当检测到状态变化时发送相应的通知

### 通知类型

- **开播通知**: 检测到从未开播变为开播状态
- **下播通知**: 检测到从开播变为未开播状态

## API 接口

插件使用以下 B 站官方 API 接口：

- `https://api.live.bilibili.com/room/v1/Room/get_info` - 获取直播间基本信息

## 使用示例

### 配置示例

```json
{
  "check_interval": 30,
  "notification_group": "123456789",
  "room_id": 12345678,
  "streamer_name": "主播"
}
```

### 通知消息格式

**开播通知**:
```
@全体成员 主播开播啦!
房间号:12345678
标题:今天的直播内容
```

**下播通知**:
```
@全体成员 主播下播啦!
```

## 技术特性

- **异步处理**: 基于 asyncio 的异步架构，不阻塞主线程
- **容错机制**: 完善的异常处理，确保插件稳定运行
- **数据验证**: 严格的 API 响应数据验证和类型转换
- **资源管理**: 自动管理网络连接和资源清理
- **日志记录**: 详细的调试和运行日志

## 依赖项

- `requests` - HTTP 客户端库
- `pydantic` - 数据验证和序列化
- `nonebot` - QQ 机器人框架（通过 Nekro Agent 提供）

## 注意事项

1. **请求频率**: 建议轮询间隔不少于 10 秒，避免频繁请求被 B 站限制
2. **网络环境**: 确保服务器能够正常访问 B 站 API
3. **群号配置**: 必须正确配置通知群号才能收到通知
4. **权限要求**: 确保机器人有发送群消息的权限

## 故障排除

### 常见问题

1. **收不到通知**
   - 检查 `notification_group` 配置是否正确
   - 确认机器人是否有该群的消息发送权限

2. **API 调用失败**
   - 检查网络连接是否正常
   - 确认房间号是否正确

3. **插件加载失败**
   - 检查文件结构是否完整
   - 查看 Nekro Agent 日志获取详细错误信息

### 调试方法

插件会输出详细的调试日志，可通过 Nekro Agent 的日志系统查看运行状态和错误信息。

## 版本信息

- **版本**: 0.1.0
- **作者**: yang208115
- **项目地址**: https://github.com/yang208115/nekro-plugin-bilibili

## 许可证

本项目遵循 [GPL v3.0](LICENSE.md) 许可证开源。

## 贡献

欢迎提交 Issue 和 Pull Request 来改进这个插件。
